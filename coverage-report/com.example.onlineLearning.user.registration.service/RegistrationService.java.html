<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RegistrationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">onlineLearning</a> &gt; <a href="index.source.html" class="el_package">com.example.onlineLearning.user.registration.service</a> &gt; <span class="el_source">RegistrationService.java</span></div><h1>RegistrationService.java</h1><pre class="source lang-java linenums">package com.example.onlineLearning.user.registration.service;

import com.example.onlineLearning.user.appUser.model.AppUser;
import com.example.onlineLearning.user.appUser.model.AppUserRole;
import com.example.onlineLearning.user.appUser.repository.AppUserRepository;
import com.example.onlineLearning.user.appUser.service.AppUserService;
import com.example.onlineLearning.user.email.EmailSender;
import com.example.onlineLearning.user.registration.model.RegistrationRequest;
import com.example.onlineLearning.user.registration.token.ConfirmationToken;
import com.example.onlineLearning.user.registration.token.ConfirmationTokenService;
import jakarta.transaction.Transactional;
import lombok.AllArgsConstructor;
import java.util.List;

import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;

@Service
<span class="fc" id="L21">@AllArgsConstructor</span>
public class RegistrationService {
    private final AppUserService appUserService;
    private EmailValidator emailValidator;
    private ConfirmationTokenService confirmationTokenService;
    private AppUserRepository appUserRepository;
    private  final EmailSender emailSender;
    private  final BCryptPasswordEncoder bCryptPasswordEncoder;

    public String register(RegistrationRequest registrationRequest) {
<span class="fc" id="L31">        boolean isValidEmail = emailValidator.test(registrationRequest.getEmail());</span>
<span class="pc bpc" id="L32" title="1 of 2 branches missed.">        if(!isValidEmail){</span>
<span class="nc" id="L33">            throw new IllegalStateException(&quot;email not valid&quot;);</span>
        }
<span class="fc" id="L35">        String token = appUserService.singUpUser(new AppUser(</span>
<span class="fc" id="L36">                registrationRequest.getName(),</span>
<span class="fc" id="L37">                registrationRequest.getLastName(),</span>
<span class="fc" id="L38">                registrationRequest.getEmail(),</span>
<span class="fc" id="L39">                registrationRequest.getPassword(),</span>
<span class="fc" id="L40">                registrationRequest.getPasswordCode(),</span>
                AppUserRole.USER
        ));
<span class="fc" id="L43">        String link = &quot;http://localhost:8080/registration/confirm?token=&quot; + token;</span>
<span class="fc" id="L44">        emailSender.send(</span>
<span class="fc" id="L45">                registrationRequest.getEmail(),</span>
<span class="fc" id="L46">                buildEmail(registrationRequest.getName(), link));</span>

<span class="fc" id="L48">        return token;</span>


    }


    @Transactional
    public String confirmToken(String token) {
<span class="fc" id="L56">        ConfirmationToken confirmationToken = confirmationTokenService</span>
<span class="fc" id="L57">                .getToken(token)</span>
<span class="fc" id="L58">                .orElseThrow(() -&gt;</span>
<span class="nc" id="L59">                        new IllegalStateException(&quot;token not found&quot;));</span>

<span class="pc bpc" id="L61" title="1 of 2 branches missed.">        if (confirmationToken.getConfirmedAt() != null) {</span>
<span class="nc" id="L62">            throw new IllegalStateException(&quot;email already confirmed&quot;);</span>
        }

<span class="fc" id="L65">        LocalDateTime expiredAt = confirmationToken.getExpiredAt();</span>

<span class="pc bpc" id="L67" title="1 of 2 branches missed.">        if (expiredAt.isBefore(LocalDateTime.now())) {</span>
<span class="nc" id="L68">            throw new IllegalStateException(&quot;token expired&quot;);</span>
        }

<span class="fc" id="L71">        confirmationTokenService.setConfirmedAt(token);</span>
<span class="fc" id="L72">        appUserService.enableAppUser(</span>
<span class="fc" id="L73">                confirmationToken.getAppUser().getEmail());</span>
<span class="fc" id="L74">        return &quot;confirmed&quot;;</span>
    }

    //Retrieve All Registers
    public List&lt;AppUser&gt; getAllRegisters() {
<span class="fc" id="L79">        return appUserRepository.findAll();</span>

    }

    //Retrieve Only a Register
    public AppUser getOnlyRegister(Long id) {
<span class="fc" id="L85">        return appUserRepository.findById(id).orElseThrow(</span>
<span class="nc" id="L86">                () -&gt; new IllegalStateException(&quot;The register with id: &quot; + id + &quot; doesn't exist.&quot;)</span>
        );
    }

    //Edit Profile
    public AppUser updateAppUser(Long id, String name, String lastName, String email, Long passwordCode){
<span class="fc" id="L92">        AppUser register = null;</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        if(appUserRepository.existsById(id)){</span>
<span class="fc" id="L94">            register = appUserRepository.findById(id).get();</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">            if (name != null) register.setName(name);</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">            if (lastName != null) register.setLastName(lastName);</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">            if (email != null) register.setEmail(email);</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">            if (passwordCode != null) register.setPasswordCode(passwordCode);</span>
<span class="fc" id="L99">            appUserRepository.save(register);</span>

        }else {
<span class="fc" id="L102">            System.out.println(&quot;Update | The register with the id: &quot; + id + &quot; doesn't exist.&quot;);</span>
        }
<span class="fc" id="L104">        return register;</span>
    }

    //Delete Register
    public AppUser deleteAppUser(Long id) {
<span class="fc" id="L109">        AppUser register = null;</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (appUserRepository.existsById(id)) {</span>
<span class="fc" id="L111">            register = appUserRepository.findById(id).orElseThrow();</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">            if (register.getDeletedAccount() == false) register.setDeletedAccount(true);</span>
<span class="fc" id="L113">            appUserRepository.save(register);</span>
        }else {
<span class="nc" id="L115">            System.out.println(&quot;Delete | The register with the id: &quot; + id + &quot; doesn't exist.&quot;);</span>
        }
<span class="fc" id="L117">        return register;</span>
    }

    //ChangePassword when you remember it
    public AppUser updatePassword(Long id, String password, String newPassword) {
<span class="fc" id="L122">        AppUser register = null;</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">        if (appUserRepository.existsById(id)) {</span>
<span class="fc" id="L124">            register = appUserRepository.findById(id).get();</span>
<span class="pc bpc" id="L125" title="2 of 4 branches missed.">            if ((password != null) &amp;&amp; (newPassword != null)) {</span>
<span class="fc" id="L126">                boolean compare = bCryptPasswordEncoder.matches(password,register.getPassword());</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">                if (compare) {</span>
<span class="nc" id="L128">                    String encodedPassword = bCryptPasswordEncoder.encode(register.getPassword());</span>
<span class="nc" id="L129">                    newPassword = encodedPassword;</span>
<span class="nc" id="L130">                    register.setPassword(newPassword);</span>
<span class="nc" id="L131">                    appUserRepository.save(register);</span>
<span class="nc" id="L132">                }else {</span>
<span class="fc" id="L133">                    throw new IllegalStateException(&quot;Please review your password. Try again.&quot;);</span>
                }
            }
<span class="nc" id="L136">            appUserRepository.save(register);</span>

        } else {
<span class="fc" id="L139">            System.out.println(&quot;Update | The user with the id: &quot; + id + &quot; doesn't exist.&quot;);</span>
        }
<span class="fc" id="L141">        return register;</span>
    }

    public AppUser forgotPassword(Long id, Long passwordCode, String newPassword) {
<span class="nc" id="L145">        AppUser register = null;</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (appUserRepository.existsById(id)) {</span>
<span class="nc" id="L147">            register = appUserRepository.findById(id).get();</span>
<span class="nc bnc" id="L148" title="All 4 branches missed.">            if (passwordCode != null &amp;&amp; passwordCode.equals(register.getPasswordCode())) {</span>
<span class="nc" id="L149">                String encodedPassword = bCryptPasswordEncoder.encode(newPassword);</span>
<span class="nc" id="L150">                register.setPassword(encodedPassword);</span>
<span class="nc" id="L151">                appUserRepository.save(register);</span>
<span class="nc" id="L152">            }</span>
        } else {
<span class="nc" id="L154">            System.out.println(&quot;Update | The register with the id: &quot; + id + &quot; doesn't exist.&quot;);</span>
        }
<span class="nc" id="L156">        return register;</span>
    }


    private String buildEmail(String name, String link) {
<span class="fc" id="L161">        return &quot;&lt;div style=\&quot;font-family:Helvetica,Arial,sans-serif;font-size:16px;margin:0;color:#0b0c0c\&quot;&gt;\n&quot; +</span>
                &quot;\n&quot; +
                &quot;&lt;span style=\&quot;display:none;font-size:1px;color:#fff;max-height:0\&quot;&gt;&lt;/span&gt;\n&quot; +
                &quot;\n&quot; +
                &quot;  &lt;table role=\&quot;presentation\&quot; width=\&quot;100%\&quot; style=\&quot;border-collapse:collapse;min-width:100%;width:100%!important\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;0\&quot; border=\&quot;0\&quot;&gt;\n&quot; +
                &quot;    &lt;tbody&gt;&lt;tr&gt;\n&quot; +
                &quot;      &lt;td width=\&quot;100%\&quot; height=\&quot;53\&quot; bgcolor=\&quot;#0b0c0c\&quot;&gt;\n&quot; +
                &quot;        \n&quot; +
                &quot;        &lt;table role=\&quot;presentation\&quot; width=\&quot;100%\&quot; style=\&quot;border-collapse:collapse;max-width:580px\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;0\&quot; border=\&quot;0\&quot; align=\&quot;center\&quot;&gt;\n&quot; +
                &quot;          &lt;tbody&gt;&lt;tr&gt;\n&quot; +
                &quot;            &lt;td width=\&quot;70\&quot; bgcolor=\&quot;#0b0c0c\&quot; valign=\&quot;middle\&quot;&gt;\n&quot; +
                &quot;                &lt;table role=\&quot;presentation\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;0\&quot; border=\&quot;0\&quot; style=\&quot;border-collapse:collapse\&quot;&gt;\n&quot; +
                &quot;                  &lt;tbody&gt;&lt;tr&gt;\n&quot; +
                &quot;                    &lt;td style=\&quot;padding-left:10px\&quot;&gt;\n&quot; +
                &quot;                  \n&quot; +
                &quot;                    &lt;/td&gt;\n&quot; +
                &quot;                    &lt;td style=\&quot;font-size:28px;line-height:1.315789474;Margin-top:4px;padding-left:10px\&quot;&gt;\n&quot; +
                &quot;                      &lt;span style=\&quot;font-family:Helvetica,Arial,sans-serif;font-weight:700;color:#ffffff;text-decoration:none;vertical-align:top;display:inline-block\&quot;&gt;Confirm your email&lt;/span&gt;\n&quot; +
                &quot;                    &lt;/td&gt;\n&quot; +
                &quot;                  &lt;/tr&gt;\n&quot; +
                &quot;                &lt;/tbody&gt;&lt;/table&gt;\n&quot; +
                &quot;              &lt;/a&gt;\n&quot; +
                &quot;            &lt;/td&gt;\n&quot; +
                &quot;          &lt;/tr&gt;\n&quot; +
                &quot;        &lt;/tbody&gt;&lt;/table&gt;\n&quot; +
                &quot;        \n&quot; +
                &quot;      &lt;/td&gt;\n&quot; +
                &quot;    &lt;/tr&gt;\n&quot; +
                &quot;  &lt;/tbody&gt;&lt;/table&gt;\n&quot; +
                &quot;  &lt;table role=\&quot;presentation\&quot; class=\&quot;m_-6186904992287805515content\&quot; align=\&quot;center\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;0\&quot; border=\&quot;0\&quot; style=\&quot;border-collapse:collapse;max-width:580px;width:100%!important\&quot; width=\&quot;100%\&quot;&gt;\n&quot; +
                &quot;    &lt;tbody&gt;&lt;tr&gt;\n&quot; +
                &quot;      &lt;td width=\&quot;10\&quot; height=\&quot;10\&quot; valign=\&quot;middle\&quot;&gt;&lt;/td&gt;\n&quot; +
                &quot;      &lt;td&gt;\n&quot; +
                &quot;        \n&quot; +
                &quot;                &lt;table role=\&quot;presentation\&quot; width=\&quot;100%\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;0\&quot; border=\&quot;0\&quot; style=\&quot;border-collapse:collapse\&quot;&gt;\n&quot; +
                &quot;                  &lt;tbody&gt;&lt;tr&gt;\n&quot; +
                &quot;                    &lt;td bgcolor=\&quot;#1D70B8\&quot; width=\&quot;100%\&quot; height=\&quot;10\&quot;&gt;&lt;/td&gt;\n&quot; +
                &quot;                  &lt;/tr&gt;\n&quot; +
                &quot;                &lt;/tbody&gt;&lt;/table&gt;\n&quot; +
                &quot;        \n&quot; +
                &quot;      &lt;/td&gt;\n&quot; +
                &quot;      &lt;td width=\&quot;10\&quot; valign=\&quot;middle\&quot; height=\&quot;10\&quot;&gt;&lt;/td&gt;\n&quot; +
                &quot;    &lt;/tr&gt;\n&quot; +
                &quot;  &lt;/tbody&gt;&lt;/table&gt;\n&quot; +
                &quot;\n&quot; +
                &quot;\n&quot; +
                &quot;\n&quot; +
                &quot;  &lt;table role=\&quot;presentation\&quot; class=\&quot;m_-6186904992287805515content\&quot; align=\&quot;center\&quot; cellpadding=\&quot;0\&quot; cellspacing=\&quot;0\&quot; border=\&quot;0\&quot; style=\&quot;border-collapse:collapse;max-width:580px;width:100%!important\&quot; width=\&quot;100%\&quot;&gt;\n&quot; +
                &quot;    &lt;tbody&gt;&lt;tr&gt;\n&quot; +
                &quot;      &lt;td height=\&quot;30\&quot;&gt;&lt;br&gt;&lt;/td&gt;\n&quot; +
                &quot;    &lt;/tr&gt;\n&quot; +
                &quot;    &lt;tr&gt;\n&quot; +
                &quot;      &lt;td width=\&quot;10\&quot; valign=\&quot;middle\&quot;&gt;&lt;br&gt;&lt;/td&gt;\n&quot; +
                &quot;      &lt;td style=\&quot;font-family:Helvetica,Arial,sans-serif;font-size:19px;line-height:1.315789474;max-width:560px\&quot;&gt;\n&quot; +
                &quot;        \n&quot; +
                &quot;            &lt;p style=\&quot;Margin:0 0 20px 0;font-size:19px;line-height:25px;color:#0b0c0c\&quot;&gt;Hi &quot; + name + &quot;,&lt;/p&gt;&lt;p style=\&quot;Margin:0 0 20px 0;font-size:19px;line-height:25px;color:#0b0c0c\&quot;&gt; Thank you for registering. Please click on the below link to activate your account: &lt;/p&gt;&lt;blockquote style=\&quot;Margin:0 0 20px 0;border-left:10px solid #b1b4b6;padding:15px 0 0.1px 15px;font-size:19px;line-height:25px\&quot;&gt;&lt;p style=\&quot;Margin:0 0 20px 0;font-size:19px;line-height:25px;color:#0b0c0c\&quot;&gt; &lt;a href=\&quot;&quot; + link + &quot;\&quot;&gt;Activate Now&lt;/a&gt; &lt;/p&gt;&lt;/blockquote&gt;\n Link will expire in 15 minutes. &lt;p&gt;See you soon&lt;/p&gt;&quot; +
                &quot;        \n&quot; +
                &quot;      &lt;/td&gt;\n&quot; +
                &quot;      &lt;td width=\&quot;10\&quot; valign=\&quot;middle\&quot;&gt;&lt;br&gt;&lt;/td&gt;\n&quot; +
                &quot;    &lt;/tr&gt;\n&quot; +
                &quot;    &lt;tr&gt;\n&quot; +
                &quot;      &lt;td height=\&quot;30\&quot;&gt;&lt;br&gt;&lt;/td&gt;\n&quot; +
                &quot;    &lt;/tr&gt;\n&quot; +
                &quot;  &lt;/tbody&gt;&lt;/table&gt;&lt;div class=\&quot;yj6qo\&quot;&gt;&lt;/div&gt;&lt;div class=\&quot;adL\&quot;&gt;\n&quot; +
                &quot;\n&quot; +
                &quot;&lt;/div&gt;&lt;/div&gt;&quot;;
    }








}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>